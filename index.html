<script>
const chatBody = document.getElementById('chatBody');
const userInput = document.getElementById('userInput');
const historyList = document.getElementById('historyList');

let chatHistory = [
  { role: 'bot', content: "Hello! I am Arceus AI, how can I assist you today?" }
];

class ChatCentral {
  constructor() {
    this.chatHistory = chatHistory;
    this.models = {};
    this.nodes = {};
    this.auditLog = [];
    this.blockchainQueue = [];
    this.totalBlocks = 0;
  }

  hash(str) {
    return Array.from(new TextEncoder().encode(str))
      .reduce((hash, b) => ((hash << 5) - hash + b) | 0, 0)
      .toString(16);
  }

  async pushBlock(payload, source = "SYSTEM", target = "KERNEL") {
    const previousHash = this.blockchainQueue.length
      ? this.blockchainQueue[this.blockchainQueue.length - 1].hash
      : "0".repeat(64);
    const timestamp = Date.now();
    const blockId = this.totalBlocks + 1;
    const blockContent = `${JSON.stringify(payload)}-${source}-${target}-${previousHash}-${timestamp}`;
    const blockHash = this.hash(blockContent);

    const block = { blockId, payload, source, target, previousHash, timestamp, hash: blockHash };
    this.blockchainQueue.push(block);
    this.auditLog.push(`BLOCK#${blockId}: ${source} -> ${target} | Data: ${JSON.stringify(payload)}`);
    this.totalBlocks++;
  }

  registerNode(nodeId) {
    if (!this.nodes[nodeId]) {
      this.nodes[nodeId] = { status: "active", processed: 0 };
      this.auditLog.push(`New node registered: ${nodeId}`);
    }
  }

  registerModel(modelId, description, processFunction) {
    this.models[modelId] = { description, jobs: 0, process: processFunction };
    this.auditLog.push(`Model registered: ${modelId} (${description})`);
  }

  async processInput(input) {
    const defaultModel = Object.keys(this.models)[0];
    const model = this.models[defaultModel];
    const output = [model.process(input)];
    await this.pushBlock({ input, output }, 'LocalNode', defaultModel);
    return output[0];
  }

  addToHistory(role, content) {
    this.chatHistory.push({ role, content });
    addHistoryItem(content);
  }
}

// Initialize
const chatCentral = new ChatCentral();
chatCentral.registerNode('LocalNode');

chatCentral.registerModel('Medical-Model', 'Medical Assistant', (input) => {
  const responses = {
    // Common Symptoms - English
    headache: "Try resting, drinking water, and taking a mild pain reliever.",
    fever: "Consider taking an antipyretic and resting. If the fever persists, consult a doctor.",
    cough: "Cough can be a symptom of various conditions. If it persists, seek medical attention.",
    nausea: "Try drinking small sips of liquid and resting. If it persists, consult a doctor.",
    musclePain: "Light stretching and rest can help alleviate the pain.",
    anxiety: "Try deep breathing, meditation, and if necessary, consult a therapist.",
    shortnessOfBreath: "If you feel difficulty breathing, seek medical assistance immediately.",
    chestPain: "Chest pain can be an emergency sign, consult a doctor immediately.",
    dizziness: "Dizziness can have various causes. If it’s severe or persists, consult a doctor.",
    fatigue: "Fatigue can be caused by various reasons. Try resting and seek medical advice if it continues.",
    insomnia: "Try practicing relaxation techniques before bed. If insomnia persists, consult a doctor.",
    troubleSwallowing: "This could be a symptom of various conditions, consult a doctor if it continues.",
    diarrhea: "Stay hydrated. If it persists for more than two days, consult a doctor.",
    constipation: "Try increasing fiber and water intake. If it doesn't improve, consult a doctor.",
    vomiting: "Try resting and drinking fluids slowly. If vomiting persists, consult a doctor.",
    eyeIrritation: "If you have itching, redness, or pain in your eyes, avoid rubbing them and consult an ophthalmologist.",
    allergy: "Avoid the allergen, and if necessary, take an antihistamine. If symptoms persist, consult a doctor.",
    soreThroat: "A sore throat can be caused by viral or bacterial infections. Drink warm liquids and consult a doctor if symptoms worsen.",
    runnyNose: "A runny nose is often caused by a cold or allergies. Stay hydrated and consider using saline nasal spray.",
    backPain: "For back pain, try gentle stretches and apply heat or ice. If the pain persists, consult a doctor.",
    earPain: "Ear pain can be caused by infection or pressure changes. If it persists, consult an ENT specialist.",
    bloating: "Bloating may be due to diet, constipation, or other digestive issues. Drink plenty of water and consider avoiding gassy foods.",

    // Emergency Conditions - English
    stroke: "A stroke is an emergency. If you or someone else has symptoms such as sudden weakness, numbness, or difficulty speaking, call emergency services immediately.",
    heartAttack: "A heart attack is a medical emergency. If you experience chest pain, shortness of breath, or pain radiating to your arm or jaw, seek emergency help immediately.",
    severeBleeding: "If you are bleeding heavily, apply pressure to the wound and seek immediate medical attention.",
    poisoning: "If poisoning is suspected, contact a poison control center or seek emergency medical care immediately.",
    severeAllergicReaction: "If you experience difficulty breathing, swelling, or dizziness after an allergic reaction, seek emergency medical help immediately.",
    severeBurn: "If you have a severe burn, run cool water over it and seek medical care immediately.",
    brokenBone: "If you suspect a broken bone, avoid moving the affected area and seek medical help immediately.",

    // Common Symptoms - Portuguese
    gripe: "A gripe pode ser tratada com repouso e medicamentos para aliviar os sintomas. Consulte um médico se os sintomas piorarem.",
    resfriado: "O resfriado geralmente passa em poucos dias. Descanse e beba líquidos. Se os sintomas persistirem, procure um médico.",
    artrite: "Se você tem dor nas articulações, um anti-inflamatório pode ajudar. Consulte um ortopedista para um diagnóstico adequado.",
    asma: "Se você tem dificuldade para respirar, use seu inalador. Se os sintomas não melhorarem, consulte um médico.",
    diabetes: "Controle a alimentação e a glicose no sangue. Se tiver dúvidas, consulte um endocrinologista.",
    hipertensao: "Monitore sua pressão arterial regularmente. Uma dieta balanceada e exercícios podem ajudar.",
    depressao: "Se você está se sentindo constantemente triste ou desmotivado, é importante procurar ajuda de um profissional de saúde mental.",
    hipotireoidismo: "Procure um endocrinologista para o tratamento adequado. O uso de medicamentos pode ser necessário.",

    // Emergency Conditions - Portuguese
    sepse: "A sepse é uma infecção grave. Se você tiver febre, calafrios, ritmo cardíaco rápido ou confusão, procure ajuda médica imediatamente.",
    meningite: "Meningite pode ser grave. Sintomas incluem febre, dor de cabeça e rigidez no pescoço. Procure atendimento médico imediatamente.",
    apendicite: "Se você sentir dor aguda no lado inferior direito do abdômen, pode ter apendicite. Procure ajuda médica imediatamente.",
    pedrasRins: "Pedras nos rins podem causar dor intensa nas costas ou abdômen. Beba muitos líquidos e consulte um médico para o tratamento adequado.",
    pedrasVesicula: "Se você sentir dor no lado superior direito do abdômen, pode ser causada por pedras na vesícula. Consulte um médico para uma avaliação.",
    pneumonia: "Se você tiver tosse persistente, febre e falta de ar, pode ter pneumonia. Procure ajuda médica imediatamente.",
    comaDiabetico: "O coma diabético é uma emergência. Se você tiver alta glicose no sangue, dificuldade para respirar ou confusão, procure ajuda médica imediatamente.",
    emboliaPulmonar: "Embolia pulmonar é uma condição grave que pode causar falta de ar súbita e dor no peito. Procure atendimento médico imediato.",
    ataqueCardiaco: "Um ataque cardíaco é uma emergência. Se você sentir dor no peito, falta de ar ou dor irradiando para o braço ou mandíbula, procure ajuda imediatamente.",
    insuficienciaRenal: "Se você tiver dificuldade para urinar ou dor nas costas, pode ter insuficiência renal. Procure um nefrologista imediatamente."
  };

  return responses[input.toLowerCase()] || "Sorry, I don't have a ready answer for that. Consider consulting a doctor!";
});

// Send message
async function sendMessage() {
  const text = userInput.value.trim();
  if (!text) return;

  addMessage('user', text);
  chatCentral.addToHistory('user', text);
  userInput.value = '';
  scrollToBottom();

  const typingElement = document.createElement('div');
  typingElement.className = 'message bot';
  typingElement.textContent = '...';
  chatBody.appendChild(typingElement);
  scrollToBottom();

  const botResponse = await chatCentral.processInput(text);

  chatBody.removeChild(typingElement);
  addMessage('bot', botResponse);
  chatCentral.addToHistory('bot', botResponse);
  scrollToBottom();
}

// Helper functions
function addMessage(role, content) {
  const msg = document.createElement('div');
  msg.className = 'message ' + role;
  msg.textContent = content;
  chatBody.appendChild(msg);
}

function addHistoryItem(content) {
  const item = document.createElement('div');
  item.className = 'history-item';
  item.textContent = content;
  item.onclick = () => loadHistory(content);
  historyList.appendChild(item);
}

function loadHistory(content) {
  userInput.value = content;
  userInput.focus();
}

function scrollToBottom() {
  chatBody.scrollTop = chatBody.scrollHeight;
}

userInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendMessage();
});
</script>
